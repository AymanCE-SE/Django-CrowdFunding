<!-- @format -->

{% extends 'base.html' %} {% load static %} {% load project_extras %} {% block content %}
<div class="container py-4">
  <div class="row g-4">
    <!-- Main Content -->
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h1 class="h2 mb-2">{{ project.title }}</h1>
              <button
                class="btn btn-sm btn-outline-danger report-btn"
                data-bs-toggle="modal"
                data-bs-target="#reportModal"
                data-type="project"
                data-id="{{ project.id }}">
                Report Project
              </button>

              <p class="text-muted mb-0">
                <i class="fas fa-calendar-alt me-2"></i>Created {{ project.created_at|date }}
              </p>
            </div>
            {% if is_owner %}
            <div class="dropdown">
              <button
                class="btn btn-outline-secondary dropdown-toggle"
                type="button"
                data-bs-toggle="dropdown">
                <i class="fas fa-cog"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a
                    class="dropdown-item text-primary"
                    href="{% url 'projects:edit_project' pk=project.pk %}">
                    <i class="fas fa-edit me-2"></i>Edit Project
                  </a>
                </li>
                {% if project.can_be_deleted %}
                <li>
                  <a
                    class="dropdown-item text-danger"
                    href="{% url 'projects:delete_project' pk=project.pk %}">
                    <i class="fas fa-trash me-2"></i>Delete Project
                  </a>
                </li>
                {% endif %}
              </ul>
            </div>
            {% endif %}
          </div>

          {% if project.images.exists %}
          <div
            id="projectCarousel"
            class="carousel slide mb-4"
            data-bs-ride="carousel">
            <div class="carousel-inner rounded">
              {% for image in project.images.all %}
              <div
                class="carousel-item {% if forloop.first %}active{% endif %}">
                <img
                  src="{{ image.image.url }}"
                  class="d-block w-100 project-img"
                  alt="Project Image" />
              </div>
              {% endfor %}
            </div>
            {% if project.images.count > 1 %}
            <button
              class="carousel-control-prev"
              type="button"
              data-bs-target="#projectCarousel"
              data-bs-slide="prev">
              <span class="carousel-control-prev-icon"></span>
            </button>
            <button
              class="carousel-control-next"
              type="button"
              data-bs-target="#projectCarousel"
              data-bs-slide="next">
              <span class="carousel-control-next-icon"></span>
            </button>
            <div class="carousel-indicators">
              {% for image in project.images.all %}
              <button
                type="button"
                data-bs-target="#projectCarousel"
                data-bs-slide-to="{{ forloop.counter0 }}"
                class="{% if forloop.first %}active{% endif %}"></button>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          {% endif %}

          <!-- Tabs Navigation -->
          <ul class="nav nav-pills nav-fill mb-3" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                data-bs-toggle="tab"
                data-bs-target="#description">
                <i class="fas fa-info-circle me-2"></i>Description
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#comments">
                <i class="fas fa-comments me-2"></i>Comments
                <span class="badge bg-secondary ms-1"
                  >{{ comments.count }}</span
                >
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#updates">
                <i class="fas fa-bell me-2"></i>Updates
              </button>
            </li>
          </ul>

          <!-- Tabs Content -->
          <div class="tab-content">
            <!-- Description Tab -->
            <div class="tab-pane fade show active" id="description">
              <div class="p-3">
                {{ project.details|linebreaks }} {% if project.tags.all %}
                <div class="mt-4">
                  {% for tag in project.tags.all %}
                  <span class="badge bg-light text-dark me-2"
                    >#{{ tag.name }}</span
                  >
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Comments Tab -->
            <div class="tab-pane fade" id="comments">
              <div class="p-3">
                {% if user.is_authenticated %}
                <form
                  method="post"
                  action="{% url 'projects:add_comment' pk=project.pk %}"
                  class="mb-4">
                  {% csrf_token %}
                  <div class="form-group">{{ comment_form.text }}</div>
                  <button type="submit" class="btn btn-primary mt-2">
                    <i class="fas fa-paper-plane me-2"></i>Add Comment
                  </button>
                </form>
                {% endif %}

                <div class="comments-list">
                  {% for comment in comments %}
                  <div class="card bg-light border-0 mb-3">
                    <div class="card-body">
                      <div
                        class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                          <img
                            src="{% static 'images/profile.png' %}"
                            class="rounded-circle me-2"
                            width="32"
                            height="32"
                            alt="{{ comment.user.username }}" />
                          <h6 class="card-subtitle mb-0">
                            {{ comment.user.username }}
                          </h6>
                        </div>
                        <small class="text-muted"
                          >{{ comment.created_at|timesince }} ago</small
                        >
                      </div>
                      <p class="card-text mb-1">{{ comment.text }}</p>

                      {% if user.is_authenticated %}
                      <button
                        class="btn btn-link btn-sm reply-btn"
                        data-comment-id="{{ comment.id }}">
                        Reply
                      </button>
                      <button
                        class="btn btn-sm btn-outline-danger report-btn"
                        data-bs-toggle="modal"
                        data-bs-target="#reportModal"
                        data-type="comment"
                        data-id="{{ comment.id }}">
                        Report
                      </button>
                      <div
                        class="reply-form-container"
                        id="reply-form-{{ comment.id }}"
                        style="display: none">
                        <form
                          method="post"
                          action="{% url 'projects:add_comment' pk=project.pk %}">
                          {% csrf_token %}
                          <input
                            type="hidden"
                            name="parent"
                            value="{{ comment.id }}" />
                          <textarea
                            name="text"
                            class="form-control reply-text"
                            rows="2"
                            placeholder="Write your reply..."></textarea>
                          <button
                            type="submit"
                            class="btn btn-sm btn-primary mt-2">
                            Submit Reply
                          </button>
                        </form>
                      </div>
                      {% endif %}

                      <!-- Replies -->
                      {% for reply in comment.replies.all %}
                      <div class="card bg-white border mt-2 ms-4">
                        <div class="card-body py-2 px-3">
                          <div
                            class="d-flex justify-content-between align-items-center mb-1">
                            <div class="d-flex align-items-center">
                              <img
                                src="{% static 'images/profile.png' %}"
                                class="rounded-circle me-2"
                                width="28"
                                height="28"
                                alt="{{ reply.user.username }}" />
                              <small class="fw-bold"
                                >{{ reply.user.username }}</small
                              >
                              <span class="text-muted mx-1">â†ª</span>
                              <small class="text-muted"
                                >Reply to {{ comment.user.username }}</small
                              >
                            </div>
                            <small class="text-muted"
                              >{{ reply.created_at|timesince }} ago</small
                            >
                          </div>
                          <p class="mb-0">{{ reply.text }}</p>
                        </div>
                      </div>
                      {% endfor %}
                    </div>
                  </div>
                  {% empty %}
                  <p class="text-muted">No comments yet.</p>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Updates Tab -->
            <div class="tab-pane fade" id="updates">
              <div class="p-3">
                <div class="text-center text-muted py-4">
                  <i class="fas fa-bell fa-2x mb-3"></i>
                  <p>Project updates will appear here.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar Content -->
    <div class="col-lg-4">
      <!-- Project Status -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h2 class="card-title h4 mb-3">{{ project.title }}</h2>
          <div class="progress mb-3">
            <div
              class="progress-bar bg-success"
              role="progressbar"
              style="width: {{ project.progress }}%"
              aria-valuenow="{{ project.progress }}"
              aria-valuemin="0"
              aria-valuemax="100"></div>
          </div>

          <div class="d-flex justify-content-between mb-4">
            <div class="text-center">
              <h6 class="mb-1">Raised</h6>
              <h4 class="text-success mb-0">{{ total_donations }} EGP</h4>
            </div>
            <div class="text-center">
              <h6 class="mb-1">Target</h6>
              <h4 class="mb-0">{{ project.total_target }} EGP</h4>
            </div>
          </div>

          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span><i class="fas fa-clock me-2"></i>Time Remaining</span>
              <strong>{{ project.time_remaining }}</strong>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span><i class="fas fa-users me-2"></i>Backers</span>
              <strong>{{ project.get_donation_stats.total_donors }}</strong>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <span><i class="fas fa-star me-2"></i>Rating</span>
              <strong id="avg-rating"
                >{{ average_rating|default:"No ratings" }}</strong
              >
            </div>
          </div>

          {% if user.is_authenticated %} {% with status=project.get_status %}
          <div class="mb-4">
            {% if status == 'coming_soon' %}
            <div class="alert alert-info">
              <i class="fas fa-clock me-2"></i>{{ project.get_status_message }}
            </div>
            <button class="btn btn-secondary btn-lg w-100" disabled>
              <i class="fas fa-clock me-2"></i>Coming Soon
            </button>
            {% elif status == 'ended' %}
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-circle me-2"></i>{{ project.get_status_message }}
            </div>
            <button class="btn btn-secondary btn-lg w-100" disabled>
              <i class="fas fa-times-circle me-2"></i>Project Ended
            </button>
            {% elif status == 'funded' %}
            <div class="alert alert-success">
              <i class="fas fa-check-circle me-2"></i>{{ project.get_status_message }}
            </div>
            <button class="btn btn-success btn-lg w-100" disabled>
              <i class="fas fa-check-circle me-2"></i>Fully Funded
            </button>
            {% else %}
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Target:</strong> {{ project.total_target|floatformat:2 }}
              EGP<br />
              <strong>Still Needed:</strong> {{ project.get_status_message }}
            </div>
            <a
              href="{% url 'projects:donate_to_project' pk=project.pk %}"
              class="btn btn-success btn-lg w-100">
              <i class="fas fa-hand-holding-usd me-2"></i>Donate Now
            </a>
            {% endif %}
          </div>
          {% endwith %} {% else %}
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>Please login to donate
          </div>
          <a
            href="{% url 'login' %}?next={{ request.path }}"
            class="btn btn-primary btn-lg w-100">
            <i class="fas fa-sign-in-alt me-2"></i>Login to Donate
          </a>
          {% endif %}

          <!-- Interactive Rating Widget -->
          {% if user.is_authenticated and not is_owner %}
          <div
            id="rating-widget"
            data-current-rating="{{ user_rating|default:0 }}"
            data-project-id="{{ project.pk }}">
            <div class="star-rating mb-2">
              {% for star in "12345"|make_list %}
              <i
                class="rating-star {% if user_rating|default:0 >= forloop.counter %}fas{% else %}far{% endif %} fa-star"
                data-score="{{ forloop.counter }}"></i>
              {% endfor %}
            </div>
            <form
              id="rating-form"
              method="post"
              action="{% url 'projects:rate_project' pk=project.pk %}">
              {% csrf_token %}
              <input
                type="hidden"
                name="score"
                id="rating-score"
                value="{{ user_rating|default:0 }}" />
              <button type="submit" class="btn btn-primary btn-sm">
                Submit Rating
              </button>
            </form>
          </div>
          {% elif user_rating %}
          <div>
            <span>Your rating: {{ user_rating }}</span>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Creator Info -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title">Project Creator</h5>
          <div class="d-flex align-items-center mb-3">
            <img
              src="{% static 'images/profile.png' %}"
              class="rounded-circle me-3"
              width="50"
              height="50"
              alt="{{ project.created_by.username }}" />
            <div>
              <h6 class="mb-0">{{ project.created_by.username }}</h6>
              <small class="text-muted"
                >Member since {{ project.created_by.date_joined|date }}</small
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Top Donors -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Top Supporters</h5>
          {% for donor in project.get_top_donors %}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span>{{ donor.user__username }}</span>
            <strong>{{ donor.total_amount }} EGP</strong>
          </div>
          {% empty %}
          <p class="text-muted">No donations yet.</p>
          {% endfor %}
        </div>
      </div>
    </div>
    <!-- Related Projects -->
    <div class="col-lg-12">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title">Related Projects</h5>
          {% include 'projects/components/related_projects.html' %}
        </div>
      </div>


    <!-- Report Modal -->
    <div
      class="modal fade"
      id="reportModal"
      tabindex="-1"
      aria-labelledby="reportModalLabel"
      aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="reportForm">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="reportModalLabel">Report Content</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="report_type" id="reportType" />
              <input type="hidden" name="object_id" id="reportObjectId" />
              <div class="mb-3">
                <label for="reportReason" class="form-label">Reason</label>
                <select
                  name="reason"
                  id="reportReason"
                  class="form-select"
                  required>
                  <option value="" disabled selected>Select reason</option>
                  <option value="spam">Spam</option>
                  <option value="inappropriate">Inappropriate Content</option>
                  <option value="harassment">Harassment</option>
                  <option value="fraud">Fraud</option>
                  <option value="copyright">Copyright Violation</option>
                  <option value="offensive">Offensive Content</option>
                  <option value="hate_speech">Hate Speech</option>
                  <option value="false_information">False Information</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-danger">
                Submit Report
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endblock %} {% block extra_css %}
    <style>
      /* Carousel Styles */
      .carousel {
        border-radius: 8px;
        overflow: hidden;
      }
      .project-img {
        height: 400px;
        object-fit: cover;
        transition: transform 0.3s ease-in-out;
      }
      .carousel:hover .project-img {
        transform: scale(1.02);
      }
      /* Star Rating Widget */
      .star-rating .fa-star {
        font-size: 1.5rem;
        cursor: pointer;
        color: #f0ad4e;
        margin-right: 5px;
      }

      /* Reply Form Styling */
      .reply-form-container {
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 8px;
        margin-top: 8px;
      }
      .reply-text {
        resize: vertical;
      }

      /* Carousel Custom */
      .project-img {
        height: 400px;
        object-fit: cover;
      }
    </style>
    {% endblock %} {% block extra_js %}
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const ratingWidget = document.getElementById("rating-widget");
        if (ratingWidget) {
          const stars = ratingWidget.querySelectorAll(".rating-star");
          const ratingInput = document.getElementById("rating-score");
          let currentRating =
            parseInt(ratingWidget.dataset.currentRating, 10) || 0;

          function updateStars(rating) {
            stars.forEach(function (star) {
              const starScore = parseInt(star.dataset.score, 10);
              if (starScore <= rating) {
                star.classList.remove("far");
                star.classList.add("fas");
              } else {
                star.classList.remove("fas");
                star.classList.add("far");
              }
            });
          }

          updateStars(currentRating);

          stars.forEach(function (star) {
            star.addEventListener("click", function () {
              const selectedRating = parseInt(this.dataset.score, 10);
              ratingInput.value = selectedRating;
              updateStars(selectedRating);
            });
          });

          const ratingForm = document.getElementById("rating-form");
          ratingForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(ratingForm);
            fetch(ratingForm.action, {
              method: "POST",
              headers: {
                "X-CSRFToken": document.querySelector(
                  "[name=csrfmiddlewaretoken]"
                ).value,
              },
              body: formData,
            })
              .then((response) => {
                if (!response.ok)
                  throw new Error("Network response was not ok.");
                return response.json();
              })
              .then((data) => {
                document.getElementById("avg-rating").textContent =
                  data.new_average.toFixed(2);
                alert("Thanks! Your rating has been submitted.");
              })
              .catch((error) => {
                console.error("Error submitting rating:", error);
              });
          });
        }
        // Reply Button Toggle
        const replyButtons = document.querySelectorAll(".reply-btn");
        replyButtons.forEach(function (button) {
          button.addEventListener("click", function () {
            const commentId = this.dataset.commentId;
            const replyForm = document.getElementById(
              "reply-form-" + commentId
            );
            if (
              replyForm.style.display === "none" ||
              replyForm.style.display === ""
            ) {
              replyForm.style.display = "block";
            } else {
              replyForm.style.display = "none";
            }
          });
        });

        // Report Modal Script
        const reportButtons = document.querySelectorAll(".report-btn");
        const reportForm = document.getElementById("reportForm");

        reportButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const type = button.dataset.type;
            const objectId = button.dataset.id;
            document.getElementById("reportType").value = type;
            document.getElementById("reportObjectId").value = objectId;
            document.getElementById("reportReason").value = "";
          });
        });

        reportForm.addEventListener("submit", function (e) {
          e.preventDefault();
          const formData = new FormData(reportForm);

          fetch('{% url "projects:submit_report" %}', {
            method: "POST",
            headers: {
              "X-CSRFToken": document.querySelector(
                "[name=csrfmiddlewaretoken]"
              ).value,
            },
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                alert("Report submitted successfully.");
                const modal = bootstrap.Modal.getInstance(
                  document.getElementById("reportModal")
                );
                modal.hide();
              } else {
                alert("Error: " + data.message);
              }
            })
            .catch((error) => {
              alert("An error occurred.");
              console.error(error);
            });
        });
      });
    </script>
    {% endblock %}
  </div>
</div>
